<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/restaurant-style.css">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="fas fa-store me-2"></i>
            <span id="restaurantName">Restaurant Panel</span>
        </div>
        <ul class="sidebar-menu">
            <li><a href="dashboard.html"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="orders.html" class="active"><i class="fas fa-shopping-bag"></i> Orders</a></li>
            <li><a href="menu.html"><i class="fas fa-utensils"></i> Menu</a></li>
            <li><a href="#" onclick="handleLogout(event)"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="top-bar">
            <button class="btn btn-link"><i class="fas fa-bars"></i></button>
            <div class="ms-auto" id="userInfo"></div>
        </div>

        <div class="container-fluid p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 fw-bold">Orders Management</h1>
                <button class="btn btn-primary" onclick="loadOrders()"><i class="fas fa-sync me-2"></i>Refresh</button>
            </div>

            <!-- Filters -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter" onchange="loadOrders()">
                                <option value="">All Orders</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="preparing">Preparing</option>
                                <option value="ready">Ready</option>
                                <option value="on_the_way">On the Way</option>
                                <option value="delivered">Delivered</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Orders List -->
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div id="ordersContent">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal fade" id="orderModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderModalContent"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/restaurant-api.js"></script>
    <script>
        let currentRestaurant = null;
        const orderModal = new bootstrap.Modal(document.getElementById('orderModal'));

        document.addEventListener('DOMContentLoaded', async function () {
            await checkAuth();
            await loadOrders();
        });

        async function checkAuth() {
            try {
                const response = await RestaurantAPI.checkAuth();
                if (response.authenticated) {
                    currentRestaurant = response.restaurant;
                    document.getElementById('restaurantName').textContent = currentRestaurant.name;
                    document.getElementById('userInfo').textContent = currentRestaurant.name;
                } else {
                    window.location.href = 'index.html';
                }
            } catch (error) {
                window.location.href = 'index.html';
            }
        }

        async function loadOrders() {
            const status = document.getElementById('statusFilter').value;
            const container = document.getElementById('ordersContent');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';

            try {
                const response = await RestaurantAPI.getOrders(status || null);
                displayOrders(response.data);
            } catch (error) {
                container.innerHTML = '<div class="alert alert-danger">Failed to load orders</div>';
            }
        }

        function displayOrders(orders) {
            const container = document.getElementById('ordersContent');

            if (orders.length === 0) {
                container.innerHTML = '<p class="text-center text-muted py-5">No orders found</p>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>Order ID</th><th>Customer</th><th>Phone</th><th>Items</th><th>Amount</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';

            orders.forEach(order => {
                const date = new Date(order.created_at).toLocaleString('en-IN');
                const statusClass = getStatusClass(order.status);
                html += `
                    <tr>
                        <td><strong>#${order.id}</strong></td>
                        <td>${order.customer_name}</td>
                        <td>${order.phone || 'N/A'}</td>
                        <td>${order.item_count} items</td>
                        <td><strong>₹${order.total_amount}</strong></td>
                        <td><span class="badge ${statusClass}">${order.status.replace('_', ' ')}</span></td>
                        <td><small>${date}</small></td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewOrder(${order.id})"><i class="fas fa-eye"></i></button>
                            ${order.status !== 'delivered' && order.status !== 'cancelled' && order.status !== 'on_the_way' ?
                        `<button class="btn btn-sm btn-success" onclick="updateStatus(${order.id})"><i class="fas fa-check"></i></button>` : ''}
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function viewOrder(orderId) {
            const content = document.getElementById('orderModalContent');
            content.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div></div>';
            orderModal.show();

            try {
                const response = await RestaurantAPI.getOrder(orderId);
                const order = response.data;

                let html = `
                    <div class="mb-3">
                        <h6>Customer Details</h6>
                        <p><strong>Name:</strong> ${order.customer_name}<br>
                        <strong>Phone:</strong> ${order.phone}<br>
                        <strong>Email:</strong> ${order.email}</p>
                        <p><strong>Delivery Address:</strong><br>${order.delivery_address}</p>
                    </div>
                    <div class="mb-3">
                        <h6>Order Items</h6>
                        <table class="table table-sm">
                            <thead><tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead>
                            <tbody>
                `;

                order.items.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.name} ${item.is_veg ? '<span class="badge bg-success">Veg</span>' : ''}</td>
                            <td>${item.quantity}</td>
                            <td>₹${item.price}</td>
                            <td>₹${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>
                    `;
                });

                html += `
                            </tbody>
                        </table>
                    </div>
                    <div class="mb-3">
                        <h6>Payment</h6>
                        <p><strong>Method:</strong> ${order.payment_method.toUpperCase()}<br>
                        <strong>Total Amount:</strong> <span class="h5 text-success">₹${order.total_amount}</span></p>
                    </div>
                    <div>
                        <h6>Status</h6>
                        <p><span class="badge ${getStatusClass(order.status)}">${order.status.replace('_', ' ')}</span></p>
                    </div>
                `;

                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = '<div class="alert alert-danger">Failed to load order details</div>';
            }
        }

        async function updateStatus(orderId) {
            // Restaurant can only control these statuses
            const statuses = ['pending', 'confirmed', 'preparing', 'ready', 'cancelled'];
            const statusNames = ['Pending', 'Confirmed', 'Preparing', 'Ready', 'Cancelled'];

            const result = prompt(`Select new status (enter number):\n0: Pending\n1: Confirmed\n2: Preparing\n3: Ready\n4: Cancelled`);

            if (result !== null) {
                const index = parseInt(result);
                if (index >= 0 && index < statuses.length) {
                    try {
                        await RestaurantAPI.updateOrderStatus(orderId, statuses[index]);
                        alert('Order status updated successfully!');
                        await loadOrders();
                    } catch (error) {
                        alert('Failed to update status: ' + error.message);
                    }
                }
            }
        }

        function getStatusClass(status) {
            const map = {
                'pending': 'bg-warning text-dark',
                'confirmed': 'bg-info',
                'preparing': 'bg-primary',
                'ready': 'bg-primary',
                'on_the_way': 'bg-success',
                'delivered': 'bg-success',
                'cancelled': 'bg-danger'
            };
            return map[status] || 'bg-secondary';
        }

        async function handleLogout(e) {
            e.preventDefault();
            if (confirm('Logout?')) {
                await RestaurantAPI.logout();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>

</html>